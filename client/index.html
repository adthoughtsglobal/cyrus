<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Peer Client</title>
  <script src="../scripts/reqs.js"></script>
    <script src="../scripts/peerConfig.js"></script>
  <style>
    body {
      font-family: sans-serif
    }

    #files {
      border: 1px solid #ccc;
      padding: 8px;
      max-width: 400px
    }

    .file {
      display: flex;
      justify-content: space-between;
      padding: 4px;
      cursor: pointer
    }

    .file:hover {
      background: #eee
    }

    small {
      color: #666
    }

    textarea {
      width: 400px;
      height: 80px
    }
  </style>
</head>

<body>

  <div id="status">idle</div>

  <h3>Host JSON</h3>
  <textarea id="hostJson"></textarea><br>
  <button id="saveHost">Connect</button>

  <h3>Files</h3>
  <div id="files"></div>

  <pre id="log" style="height:160px;overflow:auto;border:1px solid #ccc"></pre>

  <script>
    const statusEl = document.getElementById('status')
    const logEl = document.getElementById('log')
    const filesEl = document.getElementById('files')
    const hostJsonEl = document.getElementById('hostJson')

    const status = s => statusEl.textContent = s
    const log = (...a) => {
      logEl.textContent += a.join(' ') + '\n'
      logEl.scrollTop = logEl.scrollHeight
    }

    let conn
    let clientId = localStorage.getItem('client_id') || crypto.randomUUID()
    localStorage.setItem('client_id', clientId)

    const savedHost = localStorage.getItem('host_json')
    if (savedHost) hostJsonEl.value = savedHost

    const incomingFiles = {}

    document.getElementById('saveHost').onclick = () => {
      let parsed
      try { parsed = JSON.parse(hostJsonEl.value) }
      catch { return alert('Invalid JSON') }

      if (!parsed.peerId) return alert('Missing peerId')

      localStorage.setItem('host_json', hostJsonEl.value)
      connect(parsed.peerId)
    }

    function connect(hostPeerId) {
      startPeer(clientId);
      peer.on('open', () => {
        conn = peer.connect(hostPeerId, {
          metadata: { clientId, nick: 'Client' }
        })
        bindConnection()
      })
    }

    function bindConnection() {
      conn.on('open', () => {
        status('connected')
        log('Connected to host')
      })

      let approved = false

      conn.on('data', data => {
        if (typeof data === 'string') {
          const msg = JSON.parse(data)

          if (msg.t === 'status') {
            if (msg.p === 'approved') {
              approved = true
              status('connected')
              conn.send(JSON.stringify({ t: 'files', p: 'list' }))
            } else if (msg.p === 'pending') {
              status('waiting')
            } else {
              status('rejected')
              conn.close()
            }
            return
          }

          if (!approved) return

          if (msg.t === 'files') renderFiles(msg.p)

          if (msg.t === 'file:start')
            incomingFiles[msg.p.id] = { meta: msg.p, chunks: [], received: 0 }

          if (msg.t === 'file:end') {
            const f = incomingFiles[msg.p]
            if (!f) return
            downloadBlob(new Blob(f.chunks), f.meta.name)
            delete incomingFiles[msg.p]
          }
        } else {
          const u8 = new Uint8Array(data)
          const sep = u8.indexOf(0)
          if (sep === -1) return
          const type = new TextDecoder().decode(u8.slice(0, sep))
          const payload = u8.slice(sep + 1).buffer
          if (type !== 'file') return
          const f = Object.values(incomingFiles)[0]
          if (!f) return
          f.chunks.push(payload)
          f.received += payload.byteLength
          conn.send(JSON.stringify({
            t: 'file:ack',
            p: { id: f.meta.id, offset: f.received }
          }))
        }
      })

      conn.on('close', () => status('disconnected'))
      conn.on('error', e => log(e))
    }

    function renderFiles(list) {
      filesEl.innerHTML = ''
      list.forEach(f => {
        const d = document.createElement('div')
        d.className = 'file'
        d.innerHTML = `<span>${f.name}</span><small>${(f.size / 1024).toFixed(1)} KB</small>`
        d.onclick = () => conn.send(JSON.stringify({ t: 'files', p: { get: f.id } }))
        filesEl.appendChild(d)
      })
    }

    function downloadBlob(blob, name) {
      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = name
      a.click()
      URL.revokeObjectURL(a.href)
    }
  </script>

</body>

</html>